**Хранимая процедура** в SQL – это набор команд на языке SQL, сохраненный на сервере базы данных для повторного использования и выполнения по запросу.

Синтаксис:
```sql
CREATE PROCEDURE GetEmployeeByID(IN emp_id INT)
BEGIN
    SELECT * FROM employees WHERE id = emp_id;
END;
```

Хранимые процедуры:
- Определяются на сервере.
- Предоставляют большую производительность.
- Являются более безопасными.

Вызов процедуры:
```sql
CALL GetEmployeeByID(1);
```

Процедура с входным параметром:
```sql
ALTER PROCEDURE uspGetEmployees` 
  `@lastname VARCHAR(40) = 'abel'`
`AS`
`SELECT`
   `BusinessEntityID`
   `, FirstName`
   `, LastName`
`FROM Person.Person`
`WHERE LastName = @lastname;
```

Процедура с выходными параметрами: 
```sql
DELIMITER //

CREATE PROCEDURE calculate_order_stats(
    IN customer_id INT,
    OUT total_orders INT,
    OUT total_amount DECIMAL(10,2),
    OUT avg_amount DECIMAL(10,2)
)
BEGIN
    -- Подсчет общего количества заказов
    SELECT COUNT(*) INTO total_orders
    FROM orders 
    WHERE customer_id = customer_id;
    
    -- Подсчет общей суммы
    SELECT COALESCE(SUM(amount), 0) INTO total_amount
    FROM orders 
    WHERE customer_id = customer_id;
    
    -- Расчет средней суммы
    IF total_orders > 0 THEN
        SET avg_amount = total_amount / total_orders;
    ELSE
        SET avg_amount = 0;
    END IF;
END //

DELIMITER ;
```

Вызов такой процедуры:
```sql
CALL calculate_order_stats(123, @total_orders, @total_amount, @avg_amount);
SELECT @total_orders, @total_amount, @avg_amount;
```

Процедура с inout параметрами:

```sql
DELIMITER //

CREATE PROCEDURE apply_discount(
    INOUT price DECIMAL(10,2),
    IN discount_percent INT
)
BEGIN
    IF discount_percent BETWEEN 0 AND 100 THEN
        SET price = price * (1 - discount_percent / 100);
    END IF;
END //

DELIMITER ;
```

Вызов такой процедуры:
```sql
SET @price = 1000.00;
CALL apply_discount(@price, 15);
SELECT @price; -- Результат: 850.00
```


**Переменные в sql.**
Локальные переменные:
```sql
DELIMITER //
CREATE PROCEDURE example()
BEGIN
    DECLARE count INT DEFAULT 0;
    DECLARE total DECIMAL(10,2);
    SET count = 10;
    SELECT SUM(price) INTO total FROM products;
END //
DELIMITER ;
```

Глобальные переменные:
```sql
SET @user_count = 0;
SELECT @user_count := COUNT(*) FROM users;
SELECT @user_count;
```

Глобальные переменные можно использовать внутри всей sql сессии, а локальные только внутри процедуры.

Пользовательские переменные:
```sql
DELIMITER //

CREATE PROCEDURE calculate_order_stats(IN customer_id INT)
BEGIN
    -- Установка пользовательских переменных
    SET @total_orders = 0;
    SET @total_amount = 0;
    
    -- Расчет статистики
    SELECT COUNT(*), SUM(amount) 
    INTO @total_orders, @total_amount
    FROM orders 
    WHERE customer_id = customer_id;
    
    -- Использование переменных
    SELECT 
        @total_orders AS order_count,
        @total_amount AS total_amount,
        CASE 
            WHEN @total_orders > 0 THEN @total_amount / @total_orders
            ELSE 0 
        END AS avg_order_amount;
END //

DELIMITER ;
```
